<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Battlemap - DM Interface</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-dragon"></i> DM Control</h2>
                <div class="build-info">
                    <small>Build: BUILD_TIMESTAMP</small>
                </div>
            </div>
            
            <!-- Map Management -->
            <div class="sidebar-section">
                <h3 class="section-header" data-section="battlemaps">
                    <i class="fas fa-map"></i> Battlemaps
                    <i class="fas fa-chevron-down section-toggle"></i>
                </h3>
                <div class="section-content" id="battlemaps-content">
                    <div class="map-controls">
                        <div class="map-buttons">
                            <button id="newMapBtn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> New Map
                            </button>
                            <button id="importMapBtn" class="btn btn-secondary">
                                <i class="fas fa-download"></i> Import Map
                            </button>
                        </div>
                        <div id="mapTabs" class="map-tabs"></div>
                    </div>
                </div>
            </div>
                        
            <!-- Fog of War -->
            <div class="sidebar-section">
                <h3 class="section-header" data-section="fog-of-war">
                    <i class="fas fa-cloud"></i> Fog of War
                    <i class="fas fa-chevron-down section-toggle"></i>
                </h3>
                <div class="section-content" id="fog-of-war-content">
                    <div class="fog-controls">
                        <div class="fog-tool-group">
                            <button id="showEverythingBtn" class="tool-btn" data-tool="show-all" title="Show Everything">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button id="fogEverythingBtn" class="tool-btn" data-tool="fog-all" title="Fog Everything">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <button id="fogBrushBtn" class="tool-btn" data-tool="fog-brush" title="Fog Brush">
                                <i class="fas fa-paint-brush"></i>
                            </button>
                            <button id="revealBrushBtn" class="tool-btn" data-tool="reveal-brush" title="Reveal Brush">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <div class="fog-brush-controls">
                            <label>Brush Size:</label>
                            <input type="range" id="fogBrushSizeSlider" min="10" max="200" value="50">
                            <span id="fogBrushSizeValue">50px</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Battlegrid -->
            <div class="sidebar-section">
                <h3 class="section-header" data-section="battlegrid">
                    <i class="fas fa-th-large"></i> Battlegrid
                    <i class="fas fa-chevron-down section-toggle"></i>
                </h3>
                <div class="section-content" id="battlegrid-content">
                    <div class="battlegrid-controls">
                        <div class="view-controls">
                            <label>Type:</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" id="battlegridTypeNone" name="battlegridType" value="none" checked>
                                    <span class="radiomark"></span>
                                    None
                                </label>
                                <label class="radio-label">
                                    <input type="radio" id="battlegridTypeGrid" name="battlegridType" value="grid">
                                    <span class="radiomark"></span>
                                    Grid
                                </label>
                                <label class="radio-label">
                                    <input type="radio" id="battlegridTypeHex" name="battlegridType" value="hex">
                                    <span class="radiomark"></span>
                                    Hex
                                </label>
                            </div>
                        </div>
                        <div class="view-controls">
                            <label>Line Width:</label>
                            <input type="range" id="battlegridLineWidth" min="1" max="10" value="2" step="1">
                            <span id="battlegridLineWidthValue">2</span>
                        </div>
                        <div class="view-controls">
                            <label>Line Opacity:</label>
                            <input type="range" id="battlegridOpacity" min="0.1" max="1" value="0.5" step="0.01">
                            <span id="battlegridOpacityValue">0.5</span>
                        </div>
                        <div class="view-controls">
                            <label>Grid Size:</label>
                            <input type="range" id="battlegridSize" min="10" max="200" value="50" step="1">
                            <span id="battlegridSizeValue">50</span>
                        </div>
                        <div class="view-controls">
                            <label>Offset X:</label>
                            <input type="range" id="battlegridOffsetX" min="-200" max="200" value="0" step="1">
                            <span id="battlegridOffsetXValue">0</span>
                        </div>
                                                  <div class="view-controls">
                              <label>Offset Y:</label>
                              <input type="range" id="battlegridOffsetY" min="-200" max="200" value="0" step="1">
                              <span id="battlegridOffsetYValue">0</span>
                          </div>
                          <div class="view-controls">
                              <label>Color:</label>
                              <input type="color" id="battlegridColor" value="#ffffff">
                          </div>
                      </div>
                </div>
            </div>

            <!-- Drawing Tools -->
            <div class="sidebar-section">
                <h3 class="section-header" data-section="drawing-tools">
                    <i class="fas fa-paint-brush"></i> Drawing Tools
                    <i class="fas fa-chevron-down section-toggle"></i>
                </h3>
                <div class="section-content" id="drawing-tools-content">
                    <div class="tool-controls">
                        <div class="tool-group">
                            <button id="selectTool" class="tool-btn active" data-tool="select">
                                <i class="fas fa-mouse-pointer"></i>
                            </button>
                            <button id="selectionBoxTool" class="tool-btn" data-tool="selection-box" title="Player View Selection Box">
                                <i class="fas fa-crop"></i>
                            </button>
                            <button id="rectangleTool" class="tool-btn" data-tool="rectangle">
                                <i class="fas fa-square"></i>
                            </button>
                            <button id="circleTool" class="tool-btn" data-tool="circle">
                                <i class="fas fa-circle"></i>
                            </button>
                            <button id="lineTool" class="tool-btn" data-tool="line">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button id="imageTool" class="tool-btn" data-tool="image">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>
                        
                        <div class="color-controls">
                            <label>Color:</label>
                            <input type="color" id="drawingColor" value="#ff0000">
                            <label>Opacity:</label>
                            <input type="range" id="opacitySlider" min="0" max="100" value="100">
                            <span id="opacityValue">100%</span>
                        </div>
                        
                        <div class="size-controls">
                            <label>Size:</label>
                            <input type="range" id="sizeSlider" min="1" max="50" value="5">
                            <span id="sizeValue">5px</span>
                        </div>
                    </div>
                </div>
            </div>
            
                         <!-- Layer Management -->
             <div class="sidebar-section">
                 <h3 class="section-header" data-section="layers">
                     <i class="fas fa-layer-group"></i> Layers
                     <i class="fas fa-chevron-down section-toggle"></i>
                 </h3>
                <div class="section-content" id="layers-content">
                    <div id="layerList" class="layer-list"></div>
                </div>
            </div>
            
            <!-- Player View Control -->
            <div class="sidebar-section">
                <h3 class="section-header" data-section="player-view-control">
                    <i class="fas fa-users"></i> Player View Control
                    <i class="fas fa-chevron-down section-toggle"></i>
                </h3>
                <div class="section-content" id="player-view-control-content">
                    <div class="player-view-controls">
                        <div class="view-controls">
                            <label>Player Zoom:</label>
                            <input type="range" id="playerZoomSlider" min="0.1" max="5" step="0.1" value="1">
                            <span id="playerZoomValue">100%</span>
                        </div>
                        <div class="view-controls">
                            <label>Player Pan X (Center):</label>
                            <input type="range" id="playerPanXSlider" min="0" max="2000" value="0">
                            <span id="playerPanXValue">0px</span>
                        </div>
                        <div class="view-controls">
                            <label>Player Pan Y (Center):</label>
                            <input type="range" id="playerPanYSlider" min="0" max="2000" value="0">
                            <span id="playerPanYValue">0px</span>
                        </div>
                        <div class="view-controls">
                            <label>Player Name Font Size:</label>
                            <input type="range" id="playerNameFontSizeSlider" min="6" max="60" value="14">
                            <span id="playerNameFontSizeValue">14px</span>
                        </div>
                        <div class="view-buttons">
                            <button id="resetPlayerViewBtn" class="btn btn-secondary">
                                <i class="fas fa-home"></i> Reset View
                            </button>
                            <button id="syncPlayerViewBtn" class="btn btn-primary">
                                <i class="fas fa-sync"></i> Sync to DM View
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Players Management -->
            <div class="sidebar-section">
                <h3 class="section-header" data-section="players">
                    <i class="fas fa-user-friends"></i> Players
                    <i class="fas fa-chevron-down section-toggle"></i>
                </h3>
                           <div class="section-content" id="players-content">
               <div class="players-controls">
                   <div class="initiative-controls">
                       <button id="nextInitBtn" class="btn btn-secondary">
                           <i class="fas fa-forward"></i> Next Init
                       </button>
                   </div>
                   <div id="playersList" class="players-list"></div>
                   <div class="combat-controls">
                       <button id="endCombatBtn" class="btn btn-danger">
                           <i class="fas fa-stop-circle"></i> End Combat
                       </button>
                   </div>
                   <div class="add-player-form">
                       <div class="form-group">
                           <label for="playerName">Player Name:</label>
                           <input type="text" id="playerName" placeholder="Enter player name">
                       </div>
                       <div class="form-group">
                           <label for="playerOrientation">Orientation (degrees):</label>
                           <input type="range" id="playerOrientation" min="0" max="360" value="0">
                           <span id="playerOrientationValue">0°</span>
                       </div>
                       <div class="form-group">
                           <label for="playerInitiative">Initiative:</label>
                           <input type="number" id="playerInitiative" min="0" max="99" placeholder="0-99">
                       </div>
                       <button id="addPlayerBtn" class="btn btn-primary">
                           <i class="fas fa-plus"></i> Add Player
                       </button>
                   </div>
                </div>
            </div>
            </div>
            
            <!-- SRD 5e -->
            <div class="sidebar-section">
                <h3 class="section-header" data-section="srd-5e">
                    <i class="fas fa-book"></i> SRD 5e
                    <i class="fas fa-chevron-down section-toggle"></i>
                </h3>
                <div class="section-content" id="srd-5e-content">
                    <div class="srd-controls">
                        <button id="searchSpellBtn" class="btn btn-primary">
                            <i class="fas fa-magic"></i> Search for Spell
                        </button>
                        <button id="searchMonsterBtn" class="btn btn-primary">
                            <i class="fas fa-dragon"></i> Search for Monster
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Canvas Area -->
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="battlemapCanvas"></canvas>
                <div class="canvas-overlay">
                    <div class="zoom-controls">
                        <button id="zoomIn" class="zoom-btn"><i class="fas fa-search-plus"></i></button>
                        <button id="zoomOut" class="zoom-btn"><i class="fas fa-search-minus"></i></button>
                        <button id="resetZoom" class="zoom-btn"><i class="fas fa-expand-arrows-alt"></i></button>
                    </div>
                    
                    <div class="fog-controls-overlay">
                        <button id="arrowToolBtnOverlay" class="fog-btn active" title="Arrow Tool (Select)">
                            <i class="fas fa-mouse-pointer"></i>
                        </button>
                        <button id="fogBrushBtnOverlay" class="fog-btn" title="Fog Brush">
                            <i class="fas fa-paint-brush"></i>
                        </button>
                        <button id="revealBrushBtnOverlay" class="fog-btn" title="Reveal Brush">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button id="showEverythingBtnOverlay" class="fog-btn" title="Show Everything">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button id="fogEverythingBtnOverlay" class="fog-btn" title="Fog Everything">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                    <div class="status-bar">
                        <span id="statusText">Ready</span>
                        <span id="coordinates">0, 0</span>
                        <span id="screenCenter">Center: 0, 0</span>
                    </div>
                </div>
            </div>
            
            <!-- Sticky Windows Container -->
            <div id="stickyWindowsContainer" class="sticky-windows-container"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="newMapModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Map Vault</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Map Search Section -->
                <div class="map-search-section">
                    <h4><i class="fas fa-search"></i> Search Existing Maps</h4>
                    <div class="form-group">
                        <label for="mapSearch">Search by name:</label>
                        <input type="text" id="mapSearch" placeholder="Enter map name to search...">
                    </div>
                    <div id="mapSearchResults" class="map-search-results"></div>
                </div>
                
                <div class="map-separator">
                    <span>OR</span>
                </div>
                
                <!-- Map Upload Section -->
                <div class="map-upload-section">
                    <h4><i class="fas fa-upload"></i> Upload New Map</h4>
                    <div class="form-group">
                        <label for="mapName">Map Name:</label>
                        <input type="text" id="mapName" placeholder="Enter map name">
                    </div>
                    <div class="form-group">
                        <label for="mapDescription">Description (optional):</label>
                        <textarea id="mapDescription" placeholder="Enter map description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="mapBackground">Background Image:</label>
                        <input type="file" id="mapBackground" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Image Scaling Options:</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="imageScaling" value="none" checked>
                                <span class="radiomark"></span>
                                No scaling (use original size)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="imageScaling" value="fullhd">
                                <span class="radiomark"></span>
                                Scale to Full HD (1920x1080) - maintain aspect ratio
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="imageScaling" value="4k">
                                <span class="radiomark"></span>
                                Scale to 4K (4096x2160) - maintain aspect ratio
                            </label>
                        </div>
                        <small style="color: #888; font-size: 0.8rem; margin-top: 5px; display: block;">
                            Images will be scaled to fit within the selected resolution while preserving their aspect ratio. 
                            This ensures optimal display quality for different screen types.
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="saveMapPermanent">
                            <span class="checkmark"></span>
                            Save to Map Vault (permanent)
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="createMapBtn" class="btn btn-primary">Create Map</button>
                <button class="btn btn-secondary close-modal">Cancel</button>
            </div>
        </div>
    </div>
    
         <div id="imageUploadModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h3>Token Vault</h3>
                 <span class="close">&times;</span>
             </div>
             <div class="modal-body">
                 <!-- Token Search Section -->
                 <div class="token-search-section">
                     <h4><i class="fas fa-search"></i> Search Existing Tokens</h4>
                     <div class="form-group">
                         <label for="tokenSearch">Search by name:</label>
                         <input type="text" id="tokenSearch" placeholder="Enter token name to search...">
                     </div>
                     <div id="tokenSearchResults" class="token-search-results"></div>
                 </div>
                 
                 <div class="token-separator">
                     <span>OR</span>
                 </div>
                 
                 <!-- Token Upload Section -->
                 <div class="token-upload-section">
                     <h4><i class="fas fa-upload"></i> Upload New Token</h4>
                     <div class="form-group">
                         <label for="tokenImage">Select Image:</label>
                         <input type="file" id="tokenImage" accept="image/*">
                     </div>
                     <div class="form-group">
                         <label for="tokenName">Token Name:</label>
                         <input type="text" id="tokenName" placeholder="Enter token name">
                     </div>
                     <div class="form-group">
                         <label class="checkbox-label">
                             <input type="checkbox" id="savePermanent">
                             <span class="checkmark"></span>
                             Save to Token Vault (permanent)
                         </label>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <button id="uploadTokenBtn" class="btn btn-primary">Use Token</button>
                 <button class="btn btn-secondary close-modal">Cancel</button>
             </div>
         </div>
     </div>
    
    <!-- Spell Search Modal -->
    <div id="spellSearchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-magic"></i> Spell Search</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="spell-search-section">
                    <h4><i class="fas fa-search"></i> Search Spells</h4>
                    <div class="form-group">
                        <label for="spellSearch">Search by name:</label>
                        <input type="text" id="spellSearch" placeholder="Enter spell name to search...">
                    </div>
                    <div id="spellSearchResults" class="spell-search-results"></div>
                </div>
                
                <div id="spellDetailsSection" class="spell-details-section" style="display: none;">
                    <h4><i class="fas fa-info-circle"></i> Spell Details</h4>
                    <div id="spellDetailsTable" class="spell-details-table"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="showSpellToPlayerBtn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-eye"></i> Show to Player
                </button>
                <button id="stickySpellBtn" class="btn btn-warning" style="display: none;">
                    <i class="fas fa-thumbtack"></i> Sticky
                </button>
                <button class="btn btn-secondary close-modal">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Monster Search Modal -->
    <div id="monsterSearchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-dragon"></i> Monster Search</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="monster-search-section">
                    <h4><i class="fas fa-search"></i> Search Monsters</h4>
                    <div class="form-group">
                        <label for="monsterSearch">Search by name:</label>
                        <input type="text" id="monsterSearch" placeholder="Enter monster name to search...">
                    </div>
                    <div id="monsterSearchResults" class="monster-search-results"></div>
                </div>
                
                <div id="monsterDetailsSection" class="monster-details-section" style="display: none;">
                    <h4><i class="fas fa-info-circle"></i> Monster Details</h4>
                    <div id="monsterDetailsTable" class="monster-details-table"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="stickyMonsterBtn" class="btn btn-warning" style="display: none;">
                    <i class="fas fa-thumbtack"></i> Sticky
                </button>
                <button class="btn btn-secondary close-modal">Close</button>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="/dm.js"></script>
</body>
</html> 